#!/bin/bash

MASTERHOST="deploy-s2"
HOSTNAME=`/bin/hostname`
SCRIPT="/usr/wikia/backend/bin/medusa/upload_apache_config"
DEST="/etc/apache2/conf.d"
MAX_CONCURRENT=4

CMD=$1
shift

case $CMD in
	upload)
		PATH=`readlink -f $1`
		if [ -z "$1" ] ; then
			echo "error: missing argument: <source_dir>"
			exit 1
		fi
		shift
		if [ -f $PATH/slot1.conf ] ; then
			SOURCE=$PATH
		elif [ -f $PATH/cookbooks/apache2/files/default/slot1.conf ] ; then
			SOURCE=$PATH/cookbooks/apache2/files/default
		fi
		if [ -z "$SOURCE" ] ; then
			echo "error: could not find slot configuration in: $PATH"
			exit 1
		fi
		echo "Connecting to $MASTERHOST..."
		/usr/bin/ssh -t $MASTERHOST sudo -i $SCRIPT sync-master "$HOSTNAME:$SOURCE"
#		/usr/bin/ssh -t $MASTERHOST $SCRIPT sync-master "$HOSTNAME:$SOURCE"
		;;
	sync-master)
		if [ "$MASTERHOST" != "$HOSTNAME" ] ; then
			echo "error: this command has to be run on master host"
			exit 1
		fi
		if [ -z "$1" ] ; then
			echo "error: source has not been provided"
			exit 1
		fi
		TMPDIR=`mktemp -d`
		cd $TMPDIR
		if [ "`pwd`" != $TMPDIR ] ; then
			echo "error: cannot create temporary directory"
			exit 1
		fi
		cd /tmp
		echo "Downloading files to $MASTERHOST..."
		/usr/bin/scp $1/slot?.conf $TMPDIR
		if [ $? -gt 0 -o ! -f $TMPDIR/slot1.conf ] ; then
			echo "error: could not download slot configuration"
			rm $TMPDIR/*
			rmdir $TMPDIR
			exit 1
		fi
		chown -R release:root $TMPDIR
		echo "Syncing all web servers (from $HOSTNAME:$TMPDIR)..."
		/usr/bin/pdsh -f $MAX_CONCURRENT -g all_web $SCRIPT sync "$HOSTNAME:$TMPDIR"
		rm $TMPDIR/*
		rmdir $TMPDIR
		;;
	sync)
		if [ ! -d $DEST -o ! -f $DEST/slot1.conf ] ; then
			echo "info: this host doesn't use medusa config"
			exit 0
		fi
		if [ -z "$1" ] ; then
			echo "error: source has not been provided"
			exit 1
		fi
		TMPDIR=`mktemp -d`
		cd $TMPDIR
		if [ "`pwd`" != $TMPDIR ] ; then
			echo "error: cannot create temporary directory"
			exit 1
		fi
		cd /tmp
		chown release:root $TMPDIR
		sudo -i -u release /usr/bin/scp $1/slot?.conf $TMPDIR
		if [ $? -gt 0 -o ! -f $TMPDIR/slot1.conf ] ; then
			echo "error: could not download slot configuration"
			rm $TMPDIR/*
			rmdir $TMPDIR
			exit 1
		fi
		chown -R root:root $TMPDIR
		cp $TMPDIR/slot?.conf $DEST
		RUNNING=`/etc/init.d/apache2 status|grep "is running"`
		if [ "$?" -eq 0 -a -n "$RUNNING" ] ; then
			RESTARTING=`/etc/init.d/apache2 restart 2>&1`
			if [ "$?" -ne 0 ] ; then
				echo "error: restarting apache failed (error message follows)"
				echo $RESTARTING
			fi
		fi
		rm $TMPDIR/*
		rmdir $TMPDIR
		echo "ok"
		;;
	*)
		echo "usage:	upload_apache_config [ upload <source_dir> | sync-master | sync ]"
		echo "		upload            - upload new configs to all web servers"
		echo "		<source_dir>      - where to get files from"
		echo "		sync-master, sync - used internally"
		;;
esac
