#!/usr/bin/perl
#
# check-disk  -  Check the onedot copy processing
#

use strict;
use warnings;

use Nagios::Plugin;
use Time::Local;

use constant LOG        => '/etc/sv/onedot-load/log/main/current';
use constant TOKYO_BASE => '/tokyo_data/stats';

our ($PROGNAME) = $0 =~ m!([^/]+)$!;
our $VERSION = '1.0';
our $WARN_FILES = 5;
our $CRIT_FILES = 7;

my $np = Nagios::Plugin->new(
	usage     => "Usage: %s",
	version   => $VERSION,
	plugin    => $PROGNAME,
	shortname => uc($PROGNAME),
	blurb     => 'Make sure we are copying data',
	timeout   => 30,
);

$np->add_arg(
  spec => 'warning|w=s',
  help => "-w, --warning=THRESHOLD\n"
    . "   Warning threshold (as a percentage) for free disk space.",
  required => 0,
);

$np->add_arg(
  spec => 'critical|c=s',
  help => "-c, --critical=THRESHOLD\n"
    . "   Critical threshold (as a percentage) for free disk space.",
  required => 0,
);

$np->getopts;

$WARN_FILES = $np->opts->warning if $np->opts->warning;
$CRIT_FILES = $np->opts->critical if $np->opts->critical;

# Determine if rsyslog is running
my $status = `sudo sv status onedot-load`;

$np->nagios_exit(CRITICAL, "Onedot copy is stopped") unless $status =~ /^run/;

foreach my $type (qw(article namespace raw user weekly_user wikia wikia_weekly)) {
	my $path = TOKYO_BASE().'/'.$type;
	my $num_files = `ls $path | wc -l`;
	chomp($num_files);

	$np->nagios_exit('CRITICAL', "The $type directory has $num_files file(s) waiting to be moved")
		if $num_files >= $CRIT_FILES;
	$np->nagios_exit('WARNING', "The $type directory has $num_files file(s) waiting to be moved")
		if $num_files >= $WARN_FILES;

}

$np->nagios_exit('OK', "Onedot copy process OK");
