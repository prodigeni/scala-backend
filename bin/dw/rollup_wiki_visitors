#!/usr/bin/perl -w

use strict;

use FindBin qw/$Bin/;
use lib "$Bin/../../lib";

use DateTime;
use Getopt::Long;
use Wikia::DW::Common;

my $dt = DateTime->now()->subtract( days => 1 );
my $time_id = $dt->ymd('-');

GetOptions( 'time_id=s' => \$time_id);

Wikia::DW::Common::log("rollup_wiki_visitors: $time_id");

my $statsdb = Wikia::DW::Common::statsdb;

$statsdb->do("DELETE FROM rollup_wiki_visitors WHERE time_id = TIMESTAMP('$time_id')");

$statsdb->do(
"REPLACE INTO rollup_wiki_visitors (
    period_id,
    time_id,
    wiki_id,
    visitors
)
SELECT 1 AS period_id,
       time_id,
       wiki_id,
       COUNT(1) AS visitors
  FROM rollup_wiki_beacon_pageviews
 WHERE period_id = 1
   AND time_id = TIMESTAMP('$time_id')
 GROUP BY wiki_id"
);

$statsdb->do('COMMIT');

$statsdb->disconnect;

Wikia::DW::Common::log('Done');

