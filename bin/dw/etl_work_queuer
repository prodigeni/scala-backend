#!/usr/bin/perl -w

use strict;

use FindBin qw/$Bin/;
use lib "$Bin/../../lib";

use Getopt::Long;
use TheSchwartz;
use Wikia::DW::Common;

my ($table) = undef;

GetOptions( 'table=s' => \$table );

die 'Please supply a table to queue jobs for' unless ($table);

my $sql = Wikia::DW::Common::load_query_file($table, 'queue');

my $client = TheSchwartz->new( databases => [ 
                                              { dsn  => 'DBI:mysql:database=statsdb_etl;host=dw-s1',
                                                user => 'statsdb',
                                                pass => '' }
                                            ] );

my $statsdb_dbh = Wikia::DW::Common::statsdb;

my $sth = $statsdb_dbh->prepare($sql);
$sth->execute;

while (my $job = $sth->fetchrow_hashref) {
    my $funcname = $job->{funcname};
    $client->insert($funcname, $job);
}

$statsdb_dbh->disconnect;

