#!/usr/bin/perl -w

use strict;

use FindBin qw/$Bin/;
use lib "$Bin/../../lib";

use DateTime;
use Getopt::Long;
use Wikia::DW::Common;

my $dt = DateTime->now()->subtract( days => 1 );
my $time_id = $dt->ymd('-');

GetOptions( 'time_id=s' => \$time_id);

Wikia::DW::Common::log("report_wiki_video_views: $time_id");

my $statsdb = Wikia::DW::Common::statsdb;

$statsdb->do("DELETE FROM report_wiki_video_views WHERE time_id = TIMESTAMP('$time_id')");

$statsdb->do(
"INSERT INTO report_wiki_video_views (
    time_id,
    wiki_id,
    pageviews,
    total_video_views,
    premium_video_views
)
SELECT pv.time_id,
       pv.wiki_id,
       MAX(pv.pageviews) AS pageviews,
       SUM(vv.views)     AS total_video_views,
       SUM(CASE WHEN vv.provider IN ('ign','screenplay') THEN vv.views ELSE 0 END) AS premium_video_views
  FROM (
        SELECT DATE('$time_id') AS time_id,
               w.wiki_id,
               IFNULL(pv.pageviews,0) AS pageviews
          FROM statsdb_mart.dimension_wikis w
          LEFT JOIN rollup_wiki_pageviews pv
            ON pv.period_id = 1 
           AND pv.time_id = DATE('$time_id')
           AND pv.wiki_id = w.wiki_id
       ) pv
  LEFT JOIN rollup_wiki_provider_views vv
    ON vv.period_id = 1 
   AND vv.time_id = DATE('$time_id')
   AND vv.wiki_id = pv.wiki_id
 GROUP BY pv.wiki_id,
          pv.time_id
HAVING SUM(vv.views) > 0"
);

$statsdb->do('COMMIT');

$statsdb->disconnect;

Wikia::DW::Common::log('Done');

